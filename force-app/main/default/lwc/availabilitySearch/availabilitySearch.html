<template>
    <lightning-card>
        <div class="form-section">
            <div class="header">
                <h2>{headerText}</h2>
            </div>

            <div class="slds-p-horizontal_medium slds-p-vertical_small">
                <div class="slds-grid slds-wrap slds-gutters">
                    <!-- Row 1 -->
                    <div class="slds-col slds-size_1-of-2 slds-large-size_1-of-5">
                        <lightning-combobox name="serviceType" label="Service Type" value={filters.serviceType}
                            options={serviceTypeOptions} onchange={handleInput} required>
                        </lightning-combobox>
                    </div>

                    <div class="slds-col slds-size_1-of-2 slds-large-size_1-of-5">
                        <lightning-input type="date" name="startDate" label="Start Date" value={filters.startDate}
                            placeholder="Select start date" onchange={handleInput} required>
                        </lightning-input>
                    </div>

                    <div class="slds-col slds-size_1-of-2 slds-large-size_1-of-5">
                        <lightning-combobox name="durationNights" label="Duration (Nights)"
                            value={filters.durationNights} options={durationOptions} onchange={handleInput} required>
                        </lightning-combobox>
                    </div>

                    <div class="slds-col slds-size_1-of-2 slds-large-size_1-of-5">
                        <lightning-input type="date" name="endDate" label="End Date" value={filters.endDate} disabled>
                        </lightning-input>
                    </div>

                    <div class="slds-col slds-size_1-of-2 slds-large-size_1-of-5">
                        <lightning-combobox name="quantityRooms" label="Quantity (Rooms)" value={filters.quantityRooms}
                            options={roomQtyOptions} onchange={handleInput} required>
                        </lightning-combobox>
                    </div>

                    <!-- Row 2 -->
                    <template if:true={loadLoc}>
                        <div class="slds-col slds-size_1-of-2 slds-large-size_1-of-5">
                            <!-- <lightning-combobox name="locationCode" label="Location" value={filters.locationCode}
                                options={locationOptions} placeholder="Select a Location" onchange={handleInput} required>
                            </lightning-combobox> -->
                            <c-multi-select-picklist label="Location(s)" required="true" show-pills="true"
                                onvaluechange={handleChangeLocation} role="cm-picklist"></c-multi-select-picklist>
                        </div>
                    </template>


                    <div class="slds-col slds-size_1-of-2 slds-large-size_1-of-5">
                        <!-- <lightning-combobox name="starRating" label="Star Rating" value={filters.starRating}
                            options={starOptions} onchange={handleInput}>
                        </lightning-combobox> -->
                        <c-multi-select-picklist label="Star Rating(s)" show-pills="true"
                            onvaluechange={handleChangeStarRating} role="star-picklist"></c-multi-select-picklist>
                    </div>

                    <div class="slds-col slds-size_1-of-2 slds-large-size_1-of-5">
                        <!-- <lightning-combobox name="supplierStatus" label="Supplier Status" value={filters.supplierStatus}
                            options={anyOptions} onchange={handleInput}>
                        </lightning-combobox> -->
                        <c-multi-select-picklist label="Supplier Status(es)" show-pills="true"
                            onvaluechange={handleChangeSupplierStatus} role="status-picklist">
                        </c-multi-select-picklist>
                    </div>

                    <template if:true={loadAttractions}>
                        <div class="slds-col slds-size_1-of-2 slds-large-size_1-of-5">
                            <!-- <lightning-input type="text" name="attractions" label="Attractions" value={filters.attractions}
                            onchange={handleInput}>
                        </lightning-input> -->
                            <c-multi-select-picklist label="Attractions" show-pills="true"
                                onvaluechange={handleChangeAttractions} role="attractions-picklist">
                            </c-multi-select-picklist>
                        </div>
                    </template>

                    <div class="slds-col slds-size_1-of-2 slds-large-size_1-of-5">
                        <lightning-combobox name="liveAvailability" label="Live Availability"
                            value={filters.liveAvailability} options={liveAvailOptions} onchange={handleInput}>
                        </lightning-combobox>
                    </div>

                    <!-- Row 3 -->
                    <div class="slds-col slds-size_3-of-5">
                        <!-- <lightning-input type="text" name="supplierName" label="Supplier Name"
                            placeholder="Supplier Name" value={filters.supplierName} onchange={handleInput}>
                        </lightning-input> -->
                        <c-multi-select-picklist label="Supplier(s)" show-pills="true"
                            onvaluechange={handleChangeSupplier} role="cms-picklist"></c-multi-select-picklist>
                    </div>

                    <div class="slds-col slds-size_2-of-5 margin-search">
                        <button class="search-btn" onclick={handleSearch}>Search</button>
                    </div>
                </div>
            </div>
        </div>

        <template if:true={loading}>
            <lightning-spinner alternative-text="Loading" size="medium" class="spinner-class" variant="brand">
            </lightning-spinner>
        </template>

        <!-- GROUPED RESULTS (no toolbar filters) -->
        <template if:true={groups.length}>
            <div class="result-section">
                <div>
                    <p class="result-hadding">Hotels</p>
                </div>
                <template for:each={groups} for:item="grp">
                    <div key={grp.crmCode} class="group-block">
                        <div class="supplier-header-row">
                            <div class="supplier-cell supplier-name">
                                <strong>{grp.supplier}</strong>
                            </div>

                            <!-- Check-in (editable per hotel) -->
                            <div class="supplier-cell date-cell">
                                <span class="header-suffix">Start Date</span>
                                <lightning-input type="date" name="startDate" value={grp.uiStartDate}
                                    data-crm={grp.crmCode} onchange={handleGroupHeaderChange} class="header-input"
                                    variant="label-hidden">
                                </lightning-input>
                            </div>

                            <!-- Check-out (computed, read-only in header) -->
                            <div class="supplier-cell date-cell">
                                <span class="header-suffix">End Date</span>
                                <lightning-input type="date" value={grp.uiEndDate} disabled class="header-input"
                                    variant="label-hidden">
                                </lightning-input>
                            </div>

                            <!-- Nights (editable per hotel) -->
                            <div class="supplier-cell integer-cell">
                                <span class="header-suffix">Nights</span>
                                <lightning-input type="number" name="durationNights" value={grp.uiDurationNights}
                                    min="1" max="30" step="1" data-crm={grp.crmCode} onchange={handleGroupHeaderChange}
                                    class="header-input" variant="label-hidden">
                                </lightning-input>
                            </div>

                            <!-- Rooms (editable per hotel) -->
                            <div class="supplier-cell integer-cell">
                                <span class="header-suffix">Rooms</span>
                                <lightning-input type="number" name="quantityRooms" value={grp.uiQuantityRooms} min="1"
                                    max="9" step="1" data-crm={grp.crmCode} onchange={handleGroupHeaderChange}
                                    class="header-input" variant="label-hidden">
                                </lightning-input>
                            </div>

                            <!-- Locality (read-only) -->
                            <div class="supplier-cell hotelname-cell">{grp.firstLocality}</div>

                            <!-- Star rating (editable per hotel) -->
                            <div class="supplier-cell">
                                <span class="header-suffix">Star Rating</span>
                                <lightning-combobox name="starRating" value={grp.uiStarRating}
                                    options={starHeaderOptions} placeholder="Any" data-crm={grp.crmCode}
                                    onchange={handleGroupHeaderChange} dropdown-alignment="left"
                                    class="header-combobox">
                                </lightning-combobox>
                            </div>

                            <!-- Per-hotel Search -->
                            <!-- Star rating (editable per hotel) -->
                            <div class="supplier-cell search-cell">
                                <button class="search-btn header-search-btn" onclick={handleGroupSearch}
                                    data-crm={grp.crmCode} disabled={grp.loading}>
                                    <template if:true={grp.loading}>Searchingâ€¦</template>
                                    <template if:false={grp.loading}>Search</template>
                                </button>
                            </div>
                        </div>

                        <div class="slds-scrollable_x">
                            <table
                                class="slds-table slds-table_cell-buffer slds-table_bordered slds-table_col-bordered">
                                <thead>
                                    <tr>
                                        <th scope="col">
                                            <div class="slds-truncate">Service</div>
                                        </th>
                                        <th scope="col">
                                            <div class="slds-truncate">Rate Category</div>
                                        </th>
                                        <th scope="col">
                                            <div class="slds-truncate">Rate Description</div>
                                        </th>
                                        <th scope="col">
                                            <div class="slds-truncate">Child Policy</div>
                                        </th>
                                        <th scope="col">
                                            <div class="slds-truncate">In Cancellation</div>
                                        </th>
                                        <th scope="col">
                                            <div class="slds-truncate">Nett</div>
                                        </th>
                                        <th scope="col">
                                            <div class="slds-truncate">Sell</div>
                                        </th>
                                        <th scope="col">
                                            <div class="slds-truncate">Status</div>
                                        </th>
                                        <th scope="col">
                                            <div class="slds-truncate">Add</div>
                                        </th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <template for:each={grp.items} for:item="row">
                                        <tr key={row.id}>
                                            <td data-label="Service">
                                                <div class="slds-truncate">{row.service}</div>
                                            </td>
                                            <td data-label="Rate Category">
                                                <div class="slds-truncate">{row.rateCategory}</div>
                                            </td>
                                            <td data-label="Rate Description">
                                                <div class="slds-truncate" title={row.rateDescription}>
                                                    {row.rateDescription}
                                                </div>
                                            </td>
                                            <td data-label="Child Policy">
                                                <div class="slds-truncate" title={row.childPolicy}>
                                                    {row.childPolicy}
                                                </div>
                                            </td>

                                            <td data-label="In Cancellation">
                                                <div class="slds-truncate">{row.inCancellation}</div>
                                            </td>
                                            <td data-label="Nett">
                                                <div class="slds-truncate">{row.nett}</div>
                                            </td>
                                            <td data-label="Sell">
                                                <div class="slds-truncate">{row.sell}</div>
                                            </td>
                                            <td data-label="Status">
                                                <div class={row.statusClass}>{row.status}</div>
                                            </td>
                                            <td data-label="Add">
                                                <button onclick={handleAdd} data-row-id={row.id}
                                                    disabled={row.addDisabled} class="add-button">
                                                    Add
                                                </button>
                                            </td>
                                        </tr>
                                    </template>
                                    <template if:false={grp.items.length}>
                                        <tr>
                                            <td colspan="9" class="slds-text-align_center slds-text-color_weak">No
                                                options</td>
                                        </tr>
                                    </template>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </template>
            </div>
        </template>

        <template if:true={showNoHotels}>
            <div class="result-section">
                <div class="no-results">
                    <lightning-icon icon-name="utility:search" size="small" class="no-results-icon"></lightning-icon>
                    <div>
                        <div class="no-results-title">No hotels found please.</div>
                        <div class="no-results-sub">Try different dates, rooms, location, or star rating.</div>
                    </div>
                </div>
            </div>
        </template>

        <template if:true={error}>
            <div class="slds-p-around_small slds-text-color_error error-section">{error}</div>
        </template>
    </lightning-card>
</template>
